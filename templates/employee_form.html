<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayslipSnap ‚Äî {{ 'Edit' if employee else 'Add' }} Employee</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:#f0f4f8;min-height:100vh}.topbar{background:#141926;border-bottom:1px solid #2A3148;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}.topbar h1{font-size:20px;font-weight:700;color:#E8ECF4}.topbar h1 span{color:#7c3aed}.topbar a{font-size:13px;color:#8B95B0;text-decoration:none;padding:8px 14px;border-radius:8px}.main{max-width:800px;margin:0 auto;padding:24px}h2{font-size:22px;font-weight:700;color:#E8ECF4;margin-bottom:20px}.card{background:#141926;border-radius:12px;padding:24px;margin-bottom:20px}.card h3{font-size:15px;font-weight:700;color:#374151;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid #f1f5f9}.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}.form-group{margin-bottom:16px}.form-group label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:5px}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid #2A3148;border-radius:8px;font-size:14px;font-family:'DM Sans',sans-serif}.form-group input:focus,.form-group select:focus{outline:none;border-color:#7c3aed;color:#94a3b8;margin-top:3px}.toggle{display:flex;align-items:center;gap:8px;margin-bottom:12px}.toggle input[type=checkbox]{width:18px;height:18px;accent-color:#7c3aed}.toggle label{font-size:14px;color:#374151;font-weight:500}.btn{padding:13px 28px;background:#7c3aed;color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}.btn:hover{background:#6d28d9}.btn-secondary{background:#2A3148;color:#374151}.btn-secondary:hover{background:#2A3148}.actions{display:flex;justify-content:flex-end;gap:12px}.ctc-preview{background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:16px;margin-top:12px;font-size:13px;color:#6b21a8}.ctc-preview strong{font-size:16px}
        @media(max-width:768px){.row,.row-3{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="topbar"><h1>Payslip<span>Snap</span></h1><a href="/employees">‚Üê Employees</a></div>
<div class="main">
    <h2>{{ 'Edit' if employee else 'Add New' }} Employee</h2>
    <form method="POST">
        <div class="card">
            <h3>Personal Details</h3>
            <div class="row">
                <div class="form-group"><label>Payroll Country *</label>
                    <select name="payroll_country" id="countrySelect" onchange="toggleCountry()">
                        <option value="IN" {% if employee and employee.payroll_country=='IN' %}selected{% elif not employee %}selected{% endif %}>üáÆüá≥ India</option>
                        <option value="CA" {% if employee and employee.payroll_country=='CA' %}selected{% endif %}>üá®üá¶ Canada</option>
                        <option value="US" {% if employee and employee.payroll_country=='US' %}selected{% endif %}>üá∫üá∏ United States</option>
                        <option value="UK" {% if employee and employee.payroll_country=='UK' %}selected{% endif %}>üá¨üáß United Kingdom</option>
                        <option value="EU" {% if employee and employee.payroll_country=='EU' %}selected{% endif %}>üá™üá∫ European Union</option>
                        <option value="MY" {% if employee and employee.payroll_country=='MY' %}selected{% endif %}>üá≤üáæ Malaysia</option>
                    </select>
                </div>
                <div class="form-group"><label>Employee Code</label><input type="text" name="emp_code" value="{{ employee.emp_code or '' if employee else '' }}" placeholder="EMP001"></div>
            </div>
            <div class="row">
                <div class="form-group"><label>Full Name *</label><input type="text" name="name" value="{{ employee.name or '' if employee else '' }}" required placeholder="Full name"></div>
                <div class="form-group"><label>Email</label><input type="email" name="email" value="{{ employee.email or '' if employee else '' }}" placeholder="employee@company.com"></div>
            </div>
                <div class="form-group"><label>Phone</label><input type="text" name="phone" value="{{ employee.phone or '' if employee else '' }}" placeholder="+91 98765 43210"></div>
            </div>
            <div class="row-3">
                <div class="form-group"><label>Department</label><input type="text" name="department" value="{{ employee.department or '' if employee else '' }}" placeholder="Engineering"></div>
                <div class="form-group"><label>Designation</label><input type="text" name="designation" value="{{ employee.designation or '' if employee else '' }}" placeholder="Software Engineer"></div>
                <div class="form-group"><label>Date of Joining</label><input type="date" name="date_of_joining" value="{{ employee.date_of_joining or '' if employee else '' }}"></div>
            </div>
            {% if employee %}
            <div class="form-group"><label>Status</label>
                <select name="status"><option value="active" {% if employee.status=='active' %}selected{% endif %}>Active</option><option value="inactive" {% if employee.status=='inactive' %}selected{% endif %}>Inactive</option></select>
            </div>
            {% endif %}
        </div>

        <div class="card">
            <h3>Statutory Details</h3>
            <div class="row-3 india-fields">
                <div class="form-group"><label>PAN Number</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="ABCDE1234F" style="text-transform:uppercase"></div>
                <div class="form-group"><label>UAN (PF)</label><input type="text" name="uan_number" value="{{ employee.uan_number or '' if employee else '' }}" placeholder="1001234567890"></div>
                <div class="form-group"><label>ESI Number</label><input type="text" name="esi_number" value="{{ employee.esi_number or '' if employee else '' }}" placeholder="If applicable"></div>
            </div>
            <div class="row-3 canada-fields" style="display:none">
                <div class="form-group"><label>SIN (Social Insurance Number)</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="123-456-789"></div>
                <div class="form-group"><label>CRA Business Number</label><input type="text" name="uan_number" value="{{ employee.uan_number or '' if employee else '' }}" placeholder="Optional"></div>
                <div class="form-group"><label>Province</label>
                    <select name="pt_state" class="province-select">
                        {% for p in ['Ontario','British Columbia','Alberta','Quebec','Manitoba','Saskatchewan','Nova Scotia','New Brunswick'] %}
                        <option {% if employee and employee.pt_state==p %}selected{% endif %}>{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="row-3 us-fields" style="display:none">
                <div class="form-group"><label>SSN (Last 4 digits)</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="XXX-XX-1234" maxlength="11"></div>
                <div class="form-group"><label>Filing Status</label>
                    <select name="uan_number">
                        <option value="Single" {% if employee and employee.uan_number=='Single' %}selected{% endif %}>Single</option>
                        <option value="Married" {% if employee and employee.uan_number=='Married' %}selected{% endif %}>Married Filing Jointly</option>
                        <option value="Head of Household" {% if employee and employee.uan_number=='Head of Household' %}selected{% endif %}>Head of Household</option>
                    </select>
                </div>
                <div class="form-group"><label>State</label><input type="text" name="pt_state" value="{{ employee.pt_state or '' if employee else '' }}" placeholder="e.g. California"></div>
            </div>
            <div class="row-3 uk-fields" style="display:none">
                <div class="form-group"><label>NI Number</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="QQ 12 34 56 A" style="text-transform:uppercase"></div>
                <div class="form-group"><label>PAYE Reference</label><input type="text" name="uan_number" value="{{ employee.uan_number or '' if employee else '' }}" placeholder="123/AB456"></div>
                <div class="form-group"><label>Tax Code</label><input type="text" name="pt_state" value="{{ employee.pt_state or '' if employee else '' }}" placeholder="1257L"></div>
            </div>
            <div class="row-3 eu-fields" style="display:none">
                <div class="form-group"><label>Tax Identification Number</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="Tax ID"></div>
                <div class="form-group"><label>Social Security Number</label><input type="text" name="uan_number" value="{{ employee.uan_number or '' if employee else '' }}" placeholder="SS Number"></div>
                <div class="form-group"><label>Country</label><input type="text" name="pt_state" value="{{ employee.pt_state or '' if employee else '' }}" placeholder="e.g. Germany, France"></div>
            </div>
            <div class="row-3 my-fields" style="display:none">
                <div class="form-group"><label>IC Number (MyKad)</label><input type="text" name="pan_number" value="{{ employee.pan_number or '' if employee else '' }}" placeholder="e.g. 900101-14-1234"></div>
                <div class="form-group"><label>EPF Number</label><input type="text" name="uan_number" value="{{ employee.uan_number or '' if employee else '' }}" placeholder="EPF member number"></div>
                <div class="form-group"><label>SOCSO Number</label><input type="text" name="esi_number" value="{{ employee.esi_number or '' if employee else '' }}" placeholder="SOCSO/PERKESO number"></div>
            </div>
        </div>

        <div class="card">
            <h3>Bank Details</h3>
            <div class="row-3">
                <div class="form-group"><label>Bank Name</label><input type="text" name="bank_name" value="{{ employee.bank_name or '' if employee else '' }}" placeholder="HDFC Bank"></div>
                <div class="form-group"><label>Account Number</label><input type="text" name="bank_account" value="{{ employee.bank_account or '' if employee else '' }}" placeholder="1234567890"></div>
                <div class="form-group"><label>IFSC Code</label><input type="text" name="bank_ifsc" value="{{ employee.bank_ifsc or '' if employee else '' }}" placeholder="HDFC0001234" style="text-transform:uppercase"></div>
            </div>
        </div>

        <div class="card">
            <h3>Salary Structure</h3>
            <div class="row">
                <div class="form-group">
                    <label><span class="ctc-label">Annual CTC</span> <span class="curr-label">(Rs.)</span> *</label>
                    <input type="number" name="ctc_annual" id="ctcInput" value="{{ employee.ctc_annual or '' if employee else '' }}" placeholder="e.g. 600000" min="0" step="1000" onchange="calcPreview()">
                    <div class="hint india-hint">Cost to Company per year</div>
                    <div class="hint canada-hint" style="display:none">Annual gross salary (before deductions)</div>
                </div>
                <div class="form-group">
                    <label>Tax Regime</label>
                    <select name="tax_regime" id="taxRegime">
                        <option value="new" {% if employee and employee.tax_regime=='new' %}selected{% endif %}>New Regime (FY 2025-26)</option>
                        <option value="old" {% if employee and employee.tax_regime=='old' %}selected{% endif %}>Old Regime</option>
                    </select>
                    <div class="hint india-hint">New regime: lower rates, fewer deductions</div>
                </div>
            </div>
            <div class="india-salary-fields">
                <div class="row-3">
                    <div class="form-group">
                        <label>Basic (% of CTC)</label>
                        <input type="number" name="basic_percent" id="basicPct" value="{{ employee.basic_percent if employee else 40 }}" min="20" max="60" step="1" onchange="calcPreview()">
                        <div class="hint">Usually 40-50%</div>
                    </div>
                    <div class="form-group">
                        <label>HRA (% of Basic)</label>
                        <input type="number" name="hra_percent" id="hraPct" value="{{ employee.hra_percent if employee else 50 }}" min="0" max="100" step="1" onchange="calcPreview()">
                        <div class="hint">40% non-metro, 50% metro</div>
                    </div>
                    <div class="form-group">
                        <label>DA (Fixed Monthly Rs.)</label>
                        <input type="number" name="da_amount" id="daAmt" value="{{ employee.da_amount if employee else 0 }}" min="0" step="100" onchange="calcPreview()">
                        <div class="hint">Dearness Allowance (if any)</div>
                    </div>
                </div>

                <div style="display:flex;flex-wrap:wrap;gap:20px;margin-top:8px">
                    <div class="toggle"><input type="checkbox" name="pf_applicable" id="pfCheck" {% if not employee or employee.pf_applicable %}checked{% endif %} onchange="calcPreview()"><label for="pfCheck">PF Applicable (12% of Basic)</label></div>
                    <div class="toggle"><input type="checkbox" name="esi_applicable" id="esiCheck" {% if employee and employee.esi_applicable %}checked{% endif %}><label for="esiCheck">ESI Applicable (Gross < Rs.21,000)</label></div>
                    <div class="toggle"><input type="checkbox" name="pt_applicable" id="ptCheck" {% if not employee or employee.pt_applicable %}checked{% endif %}><label for="ptCheck">Professional Tax</label></div>
                </div>

                <div class="form-group" style="max-width:250px;margin-top:8px">
                    <label>PT State</label>
                    <select name="pt_state" class="india-state-select">
                        {% for s in ['Maharashtra','Karnataka','Tamil Nadu','Telangana','West Bengal','Gujarat','Andhra Pradesh','Kerala','Rajasthan','Madhya Pradesh'] %}
                        <option {% if employee and employee.pt_state==s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="simple-salary-fields" style="display:none">
                <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:#6b21a8">
                    <strong>Simple Mode:</strong> Enter your tax/deduction percentages below. They'll be applied to the gross salary automatically each month. You can name each deduction line to match your local tax structure.
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Deduction 1 ‚Äî Label</label>
                        <input type="text" name="custom_tax1_label" id="tax1Label" value="{{ employee.custom_tax1_label or '' if employee else '' }}" placeholder="e.g. Federal Tax">
                    </div>
                    <div class="form-group">
                        <label>Rate (%)</label>
                        <input type="number" name="custom_tax1_rate" id="tax1Rate" value="{{ employee.custom_tax1_rate or '' if employee else '' }}" placeholder="e.g. 22" min="0" max="100" step="0.1" oninput="calcPreview()">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Deduction 2 ‚Äî Label</label>
                        <input type="text" name="custom_tax2_label" id="tax2Label" value="{{ employee.custom_tax2_label or '' if employee else '' }}" placeholder="e.g. State Tax">
                    </div>
                    <div class="form-group">
                        <label>Rate (%)</label>
                        <input type="number" name="custom_tax2_rate" id="tax2Rate" value="{{ employee.custom_tax2_rate or '' if employee else '' }}" placeholder="e.g. 9.3" min="0" max="100" step="0.1" oninput="calcPreview()">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Deduction 3 ‚Äî Label</label>
                        <input type="text" name="custom_tax3_label" id="tax3Label" value="{{ employee.custom_tax3_label or '' if employee else '' }}" placeholder="e.g. Social Security">
                    </div>
                    <div class="form-group">
                        <label>Rate (%)</label>
                        <input type="number" name="custom_tax3_rate" id="tax3Rate" value="{{ employee.custom_tax3_rate or '' if employee else '' }}" placeholder="e.g. 6.2" min="0" max="100" step="0.1" oninput="calcPreview()">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Deduction 4 ‚Äî Label</label>
                        <input type="text" name="custom_tax4_label" id="tax4Label" value="{{ employee.custom_tax4_label or '' if employee else '' }}" placeholder="e.g. Medicare">
                    </div>
                    <div class="form-group">
                        <label>Rate (%)</label>
                        <input type="number" name="custom_tax4_rate" id="tax4Rate" value="{{ employee.custom_tax4_rate or '' if employee else '' }}" placeholder="e.g. 1.45" min="0" max="100" step="0.1" oninput="calcPreview()">
                    </div>
                </div>
            </div>

            <div class="ctc-preview" id="ctcPreview" style="display:none">
                <strong>Monthly Breakdown</strong><br>
                <span id="previewText"></span>
            </div>
        </div>

        <div class="actions">
            <a href="/employees" class="btn btn-secondary" style="text-decoration:none">Cancel</a>
            <button type="submit" class="btn">{{ 'Update' if employee else 'Add' }} Employee</button>
        </div>
    </form>
</div>
<script>
function toggleCountry() {
    const country = document.getElementById('countrySelect').value;
    const isIndia = country === 'IN';
    const isCanada = country === 'CA';
    const isSimple = ['US','UK','EU','MY'].includes(country);
    document.querySelectorAll('.india-fields,.india-salary-fields,.india-hint,.india-state-select').forEach(e => e.style.display = isIndia ? '' : 'none');
    document.querySelectorAll('.canada-fields,.canada-hint').forEach(e => e.style.display = isCanada ? '' : 'none');
    document.querySelectorAll('.us-fields').forEach(e => e.style.display = country === 'US' ? '' : 'none');
    document.querySelectorAll('.uk-fields').forEach(e => e.style.display = country === 'UK' ? '' : 'none');
    document.querySelectorAll('.eu-fields').forEach(e => e.style.display = country === 'EU' ? '' : 'none');
    document.querySelectorAll('.my-fields').forEach(e => e.style.display = country === 'MY' ? '' : 'none');
    document.querySelectorAll('.simple-salary-fields').forEach(e => e.style.display = isSimple ? '' : 'none');
    const currLabels = {'IN':'(Rs.)','CA':'(C$)','US':'($)','UK':'(GBP)','EU':'(EUR)','MY':'(RM)'};
    const ctcLabels = {'IN':'Annual CTC','CA':'Annual Gross Salary','US':'Annual Gross Salary','UK':'Annual Gross Salary','EU':'Annual Gross Salary','MY':'Annual Gross Salary'};
    document.querySelector('.ctc-label').textContent = ctcLabels[country] || 'Annual Gross Salary';
    document.querySelector('.curr-label').textContent = currLabels[country] || '($)';
    document.getElementById('taxRegime').closest('.form-group').style.display = isIndia ? '' : 'none';
    // Pre-fill tax labels for new countries
    if (isSimple) {
        const presets = {
            'US': [['Federal Tax','22'],['State Tax','5'],['Social Security','6.2'],['Medicare','1.45']],
            'UK': [['Income Tax (PAYE)','20'],['National Insurance','12'],['',''],['','']],
            'EU': [['Income Tax','25'],['Social Security','10'],['',''],['','']],
            'MY': [['EPF (KWSP)','11'],['SOCSO (PERKESO)','0.5'],['EIS','0.2'],['PCB (Tax)','10']]
        };
        const p = presets[country] || [];
        for (let i = 0; i < 4; i++) {
            const lbl = document.getElementById('tax'+(i+1)+'Label');
            const rate = document.getElementById('tax'+(i+1)+'Rate');
            if (lbl && !lbl.value && p[i]) lbl.value = p[i][0];
            if (rate && !rate.value && p[i]) rate.value = p[i][1];
        }
    }
    calcPreview();
}
function calcPreview() {
    const ctc = parseFloat(document.getElementById('ctcInput').value) || 0;
    if (ctc === 0) { document.getElementById('ctcPreview').style.display='none'; return; }
    const country = document.getElementById('countrySelect').value;
    const el = document.getElementById('ctcPreview');
    el.style.display = 'block';

    if (['US','UK','EU','MY'].includes(country)) {
        const monthly = ctc / 12;
        const currMap = {'US':'$','UK':'GBP ','EU':'EUR ','MY':'RM'};
        const c = currMap[country] || '$';
        let totalDed = 0;
        let lines = [];
        for (let i = 1; i <= 4; i++) {
            const label = document.getElementById('tax'+i+'Label').value;
            const rate = parseFloat(document.getElementById('tax'+i+'Rate').value) || 0;
            if (rate > 0) {
                const amt = monthly * rate / 100;
                totalDed += amt;
                lines.push(label + ' (' + rate + '%): ' + c + amt.toFixed(0));
            }
        }
        const net = monthly - totalDed;
        document.getElementById('previewText').innerHTML =
            'Gross/month: ' + c + monthly.toFixed(0) + ' | ' + lines.join(' | ') + '<br>' +
            '<strong>Approx Net/month: ' + c + net.toFixed(0) + '</strong> (total deductions: ' + (totalDed/monthly*100).toFixed(1) + '%)';
    } else if (country === 'CA') {
        const monthly = ctc / 12;
        const cpp = Math.min((monthly - 3500/12) * 0.0595, (71300-3500)*0.0595/12);
        const ei = Math.min(monthly * 0.0163, 65700*0.0163/12);
        const net = monthly - cpp - ei;
        document.getElementById('previewText').innerHTML =
            `Gross/month: C$${monthly.toFixed(0)} | CPP: C$${cpp.toFixed(0)} | EI: C$${ei.toFixed(0)}<br>` +
            `<strong>Approx Net/month: C$${net.toFixed(0)}</strong> (before federal & provincial tax)`;
    } else {
        const monthly = ctc / 12;
        const basicPct = parseFloat(document.getElementById('basicPct').value) / 100;
        const hraPct = parseFloat(document.getElementById('hraPct').value) / 100;
        const da = parseFloat(document.getElementById('daAmt').value) || 0;
        const basic = monthly * basicPct;
        const hra = basic * hraPct;
        const pfEr = Math.min(basic, 15000) * 0.12;
        const special = monthly - basic - hra - da - pfEr;
        const pfEe = document.getElementById('pfCheck').checked ? Math.min(basic, 15000) * 0.12 : 0;
        const gross = basic + hra + da + Math.max(0, special);
        const net = gross - pfEe;
        document.getElementById('previewText').innerHTML =
            `Basic: Rs.${basic.toFixed(0)} | HRA: Rs.${hra.toFixed(0)} | DA: Rs.${da.toFixed(0)} | Special: Rs.${Math.max(0,special).toFixed(0)}<br>` +
            `Gross: Rs.${gross.toFixed(0)} | PF(EE): Rs.${pfEe.toFixed(0)} | PF(ER): Rs.${pfEr.toFixed(0)}<br>` +
            `<strong>Approx Net/month: Rs.${net.toFixed(0)}</strong> (before TDS & PT)`;
    }
}
toggleCountry();
</script>
</body></html>
